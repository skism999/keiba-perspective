# JRAç«¶é¦¬ã‚ªãƒƒã‚ºå¤‰å‹•ç‡ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ 

## ğŸ“– ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦
JRAå…¬å¼ã‚µã‚¤ãƒˆã¨ netkeiba.com ã®ä¸¡æ–¹ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€å„ãƒ¬ãƒ¼ã‚¹ãƒ»å„é¦¬ã”ã¨ã®ã‚ªãƒƒã‚ºæƒ…å ±ã‚’å–å¾—ãƒ»é›†è¨ˆãƒ»å¯è¦–åŒ–ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚ä»¥ä¸‹ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

- **ãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å–å¾—**ï¼šå½“å¹´åˆ†ã®é–‹å‚¬æ—¥ã¨é–‹å‚¬ç«¶é¦¬å ´ã‚’ JRAã€Œãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã€ã‹ã‚‰å–å¾—  
- **ãƒ¬ãƒ¼ã‚¹æƒ…å ±å–å¾—**ï¼šé–‹å‚¬æ—¥ã®æ—¥æœ¬æ™‚é–“9:00ã«ã€å„ç«¶é¦¬å ´12ãƒ¬ãƒ¼ã‚¹åˆ†ã®ãƒ¬ãƒ¼ã‚¹ç•ªå·ã€ç™ºèµ°æ™‚åˆ»ã€ãƒ¬ãƒ¼ã‚¹åã€ãƒ¬ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã€èŠ/ãƒ€ãƒ¼ãƒˆã€è·é›¢ã€é ­æ•°ã‚’å–å¾—  
- **å‡ºèµ°é¦¬æƒ…å ±å–å¾—**ï¼šå„ãƒ¬ãƒ¼ã‚¹ã”ã¨ã«æ é †ã€é¦¬ç•ªã€é¦¬ä½“é‡ã€é¦¬åã€é¨æ‰‹ã‚’å–å¾—  
- **ã‚ªãƒƒã‚ºå–å¾—**ï¼šãƒ¬ãƒ¼ã‚¹ç™ºèµ°1æ™‚é–“å‰ã€30åˆ†å‰ã€5åˆ†å‰ã€ãƒ¬ãƒ¼ã‚¹å¾Œã«JRAå…¬å¼ã¨netkeibaã®ä¸¡æ–¹ã§ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã—ã€å¹³å‡å€¤ã‚’ç®—å‡º  
- **å¤‰å‹•ç‡è¨ˆç®—**ï¼šå„é¦¬ã”ã¨ã«ã‚ªãƒƒã‚ºã®å¤‰å‹•å€¤ãƒ»å¤‰å‹•ç‡ã‚’ç®—å‡º  
- **çµæœç™»éŒ²**ï¼šRaceçµæœï¼ˆç€é †ï¼‰ã‚’å–å¾—ã—ã€é¦¬ã”ã¨ã«è¨˜éŒ²  
- **å‡ºåŠ›**ï¼šæ—¥ã”ã¨ã«ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã€ç«¶é¦¬å ´ãƒ»ãƒ¬ãƒ¼ã‚¹ã”ã¨ã«ã‚·ãƒ¼ãƒˆåˆ†ã‘ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æ•´ç†ãƒ»å…±æœ‰  

å–å¾—ãƒ»ç™»éŒ²ã™ã‚‹é …ç›®ä¾‹ï¼ˆã‚·ãƒ¼ãƒˆåˆ—é †ï¼‰  
> ç«¶é¦¬å ´å | ãƒ¬ãƒ¼ã‚¹ç•ªå· | ç™ºèµ°æ™‚åˆ» | ãƒ¬ãƒ¼ã‚¹å | ãƒ¬ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ | èŠ/ãƒ€ãƒ¼ãƒˆ | è·é›¢ | é ­æ•° | æ  | é¦¬ç•ª | é¦¬ä½“é‡ | é¦¬å | é¨æ‰‹ | ãƒ¬ãƒ¼ã‚¹1æ™‚é–“å‰ã‚ªãƒƒã‚º | ãƒ¬ãƒ¼ã‚¹30åˆ†å‰ã‚ªãƒƒã‚º | ãƒ¬ãƒ¼ã‚¹5åˆ†å‰ã‚ªãƒƒã‚º | ãƒ¬ãƒ¼ã‚¹å¾Œã‚ªãƒƒã‚º | ã‚ªãƒƒã‚ºå¤‰å‹•å€¤ | ã‚ªãƒƒã‚ºå¤‰å‹•ç‡ | ãƒ¬ãƒ¼ã‚¹çµæœ

## â­ï¸ ä¸»ãªç‰¹å¾´
- **ãƒ‡ãƒ¼ã‚¿å†—é•·æ€§**ï¼šJRAå…¬å¼ãƒ»netkeibaä¸¡ã‚½ãƒ¼ã‚¹ã‹ã‚‰å–å¾—ã—å¹³å‡åŒ–  
- **è‡ªå‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°**ï¼šé–‹å‚¬æ—¥ã®æœ9:00ã«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï½ãƒ¬ãƒ¼ã‚¹æƒ…å ±ã‚’ä¸€æ‹¬å–å¾—ã—ãƒãƒƒãƒç™»éŒ²  
- **å¤šæ®µéšã‚ªãƒƒã‚ºå–å¾—**ï¼š1h/30m/5må‰ã¨ãƒ¬ãƒ¼ã‚¹å¾Œã®4ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å–å¾—  
- **ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ•´ç†**ï¼šæ—¥ä»˜å˜ä½ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã€ç«¶é¦¬å ´ãƒ»ãƒ¬ãƒ¼ã‚¹å˜ä½ã®ã‚¿ãƒ–ã‚’è‡ªå‹•ä½œæˆ  
- **BigQueryé€£æº**ï¼šãƒ‡ãƒ¼ã‚¿ã‚¦ã‚§ã‚¢ãƒã‚¦ã‚¹ã«ä¿å­˜ã—ã€SQLã§å‚ç…§ãƒ»é›†è¨ˆå¯èƒ½  

## ğŸ› ï¸ é–‹ç™ºç’°å¢ƒ
- **IDEï¼å®Ÿè¡Œç’°å¢ƒ**ï¼šGitHub Codespaces  
- **è¨€èª**ï¼šPython 3.9+  
- **ä¸»è¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**:
  - `requests`, `beautifulsoup4`ï¼ˆã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ï¼‰  
  - `pandas`ï¼ˆé›†è¨ˆãƒ»å¤‰å‹•ç‡è¨ˆç®—ï¼‰  
  - `google-cloud-bigquery`ï¼ˆBigQuery ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰  
  - `apscheduler`ï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ï¼‰  
  - `gspread`ï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ“ä½œï¼‰  
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**ï¼šGoogle BigQueryï¼ˆSandbox/ç„¡æ–™æ ï¼‰  

## ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆï¼ˆä¾‹ï¼‰
```  
â”œâ”€â”€ scripts/  
â”‚   â”œâ”€â”€ upsert_calendar.py      # ãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å–å¾—ãƒ»ç™»éŒ²  
â”‚   â”œâ”€â”€ upsert_races.py         # ãƒ¬ãƒ¼ã‚¹æƒ…å ±ï¼ˆ12ãƒ¬ãƒ¼ã‚¹ï¼‰å–å¾—ãƒ»ç™»éŒ²  
â”‚   â”œâ”€â”€ upsert_entries.py       # å‡ºèµ°é¦¬æƒ…å ±å–å¾—ãƒ»ç™»éŒ²  
â”‚   â”œâ”€â”€ fetch_odds.py           # ã‚ªãƒƒã‚ºå–å¾—ï¼ˆJRAãƒ»netkeibaä¸¡å¯¾å¿œï¼‰  
â”‚   â”œâ”€â”€ scheduler.py            # APSchedulerè¨­å®šãƒ»ã‚¸ãƒ§ãƒ–ç™»éŒ²  
â”‚   â”œâ”€â”€ calc_fluctuation.py     # å¤‰å‹•ç‡è¨ˆç®—ãƒ»ç™»éŒ²  
â”‚   â””â”€â”€ export_sheets.py        # æ—¥åˆ¥ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆç”Ÿæˆãƒ»ãƒ‡ãƒ¼ã‚¿æ›¸ãè¾¼ã¿  
â”œâ”€â”€ notebooks/                  # å‹•ä½œç¢ºèªç”¨ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯  
â”œâ”€â”€ requirements.txt            # Pythonä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸  
â””â”€â”€ README.md                   # æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ  
```  

## ğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †
1. **Codespacesèµ·å‹•**  
   - GitHubãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆã—ã€ŒOpen with Codespacesã€ã‚’ã‚¯ãƒªãƒƒã‚¯  

2. **ä»®æƒ³ç’°å¢ƒä½œæˆ & ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**  
   ```bash
   python3 -m venv .venv
   source .venv/bin/activate
   pip install -r requirements.txt
   ```  

3. **GCPèªè¨¼æƒ…å ±è¨­å®š**  
   ```bash
   # Secretsã«è¨­å®šã—ãŸJSONã‚’ãƒ•ã‚¡ã‚¤ãƒ«åŒ–
   echo "$GCP_CREDENTIALS_JSON" > ~/creds.json
   export GOOGLE_APPLICATION_CREDENTIALS=~/creds.json
   ```  

4. **BigQueryãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆãƒ»ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ**  
```sql
-- ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆä½œæˆï¼ˆlocationã¯å¿…è¦ã«å¿œã˜ã¦æŒ‡å®šï¼‰
CREATE SCHEMA IF NOT EXISTS `jra_odds` OPTIONS(location="asia-northeast1");

-- ãƒ¬ãƒ¼ã‚¹åŸºæœ¬æƒ…å ±ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE IF NOT EXISTS `jra_odds.race` (
  race_id         STRING,
  race_date       DATE,
  start_time      DATETIME,
  race_name       STRING,
  race_class      STRING,
  track_surface   STRING,       -- èŠ/ãƒ€ãƒ¼ãƒˆ
  distance_m      INT64,        -- è·é›¢ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
  entries_count   INT64         -- é ­æ•°
);

-- å‡ºèµ°é¦¬æƒ…å ±ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE IF NOT EXISTS `jra_odds.entries` (
  race_id     STRING,
  frame_no    INT64,
  horse_no    INT64,
  weight_kg   INT64,
  horse_name  STRING,
  jockey      STRING
);

-- ã‚ªãƒƒã‚ºã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE IF NOT EXISTS `jra_odds.odds_snapshot` (
  race_id        STRING,
  horse_no       INT64,
  snapshot_at    DATETIME,
  odds_jra       FLOAT64,
  odds_netkeiba  FLOAT64,
  odds_avg       FLOAT64,
  label          STRING        -- '1h_before','30m_before','5m_before','post_race'
);

-- å¤‰å‹•ç‡ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE IF NOT EXISTS `jra_odds.odds_fluctuation` (
  race_id           STRING,
  horse_no          INT64,
  from_label        STRING,
  to_label          STRING,
  fluctuation_value FLOAT64,
  fluctuation_rate  FLOAT64
);

-- ãƒ¬ãƒ¼ã‚¹çµæœãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE IF NOT EXISTS `jra_odds.race_results` (
  race_id         STRING,
  horse_no        INT64,
  finish_position INT64
);
```  


## ğŸ—ï¸ å®Ÿè£…ãƒ»é‹ç”¨æ‰‹é †
1. **ãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç™»éŒ²**  
   ```bash
   python scripts/upsert_calendar.py
   ```  

2. **ãƒ¬ãƒ¼ã‚¹ï¼†å‡ºèµ°é¦¬æƒ…å ±ç™»éŒ²**  
   ```bash
   python scripts/upsert_races.py
   python scripts/upsert_entries.py
   ```  

3. **ã‚ªãƒƒã‚ºå–å¾—ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«**  
   ```bash
   python scripts/scheduler.py
   ```  
   - 1h/30m/5må‰ã¨ãƒ¬ãƒ¼ã‚¹å¾Œã®å–å¾—ã‚¸ãƒ§ãƒ–ã‚’ç™»éŒ²  

4. **å¤‰å‹•ç‡è¨ˆç®—**  
   ```bash
   python scripts/calc_fluctuation.py --race_id <race_id>
   ```  

5. **ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆç”Ÿæˆãƒ»å‡ºåŠ›**  
   ```bash
   python scripts/export_sheets.py --date YYYY-MM-DD
   ```  

## ğŸ¤ ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
- ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚¿ãƒ¼æ‹›å¾…ã«ã‚ˆã‚‹å…±åŒé–‹ç™ºãŒå¯èƒ½  
- Privateãƒªãƒã‚¸ãƒˆãƒªã§ã‚‚Codespaces/Actionsç„¡æ–™æ å†…ã§åˆ©ç”¨å¯  

## ğŸ“œ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹
MIT License
```
